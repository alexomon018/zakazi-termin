name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "22"
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run Biome check
        run: yarn lint

  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn db:generate
        env:
          DATABASE_URL: postgresql://placeholder:placeholder@localhost:5432/placeholder

      - name: Run TypeScript type check
        run: yarn typecheck

  # Check for migration conflicts on PRs to main
  migration-check:
    name: Migration Safety Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for pending migrations
        run: ./.github/scripts/check-migrations.sh

      - name: Validate migration files
        run: ./.github/scripts/validate-migrations.sh

  # e2e-tests:
  #   name: E2E Tests (Playwright)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Enable Corepack
  #       run: corepack enable

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'yarn'
  #         cache-dependency-path: yarn.lock

  #     - name: Install dependencies
  #       run: yarn install --immutable

  #     - name: Install Playwright Browsers
  #       run: npx playwright install chromium --with-deps
  #       working-directory: apps/web

  #     - name: Create Neon Branch
  #       id: create-branch
  #       uses: neondatabase/create-branch-action@v6
  #       with:
  #         project_id: ${{ secrets.NEON_PROJECT_ID }}
  #         branch_name: test-${{ github.head_ref || github.ref_name }}-${{ github.run_id }}
  #         api_key: ${{ secrets.NEON_API_KEY }}
  #         parent: main

  #     - name: Generate Prisma Client
  #       run: yarn db:generate
  #       env:
  #         DATABASE_URL: ${{ steps.create-branch.outputs.db_url }}

  #     - name: Push Database Schema
  #       run: yarn workspace @zakazi-termin/prisma db:push --skip-generate
  #       env:
  #         DATABASE_URL: ${{ steps.create-branch.outputs.db_url }}

  #     - name: Run Playwright tests
  #       run: yarn test:e2e:ci
  #       env:
  #         CI: true
  #         DATABASE_URL: ${{ steps.create-branch.outputs.db_url }}
  #         NEXTAUTH_URL: http://localhost:3000
  #         NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  #         NEXT_PUBLIC_APP_URL: http://localhost:3000
  #         NEXT_PUBLIC_APP_NAME: Zakazi Termin
  #         NEXT_PUBLIC_DEFAULT_TIMEZONE: Europe/Belgrade
  #         NEXT_PUBLIC_DEFAULT_LOCALE: sr
  #         EMAIL_FROM: noreply@zakazi-termin.rs
  #         PLAYWRIGHT_TEST_MODE: "true"
  #         # Optional: Add these if needed for E2E tests
  #         # GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
  #         # GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  #         # RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

  #     - name: Upload Playwright Report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report
  #         path: apps/web/playwright-report/
  #         retention-days: 7

  #     - name: Upload Test Results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: test-results
  #         path: apps/web/test-results/
  #         retention-days: 7

  #     - name: Delete Neon Branch
  #       if: always()
  #       uses: neondatabase/delete-branch-action@v3
  #       with:
  #         project_id: ${{ secrets.NEON_PROJECT_ID }}
  #         branch: test-${{ github.head_ref || github.ref_name }}-${{ github.run_id }}
  #         api_key: ${{ secrets.NEON_API_KEY }}

