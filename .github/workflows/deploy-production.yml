name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: "Skip database migrations"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "22"
  NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
  NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  # Pre-deployment validation
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run linting
        run: yarn lint

      - name: Generate Prisma Client
        run: yarn db:generate
        env:
          DATABASE_URL: postgresql://placeholder:placeholder@localhost:5432/placeholder

      - name: Type check
        run: yarn typecheck

  # Create backup before migration
  backup-database:
    name: Backup Production Database
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.skip_migrations != true
    outputs:
      backup_branch: ${{ steps.create-backup.outputs.branch_id }}

    steps:
      - name: Create Neon Backup Branch
        id: create-backup
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ env.NEON_PROJECT_ID }}
          branch_name: backup/pre-deploy-${{ github.sha }}
          api_key: ${{ env.NEON_API_KEY }}
          parent: main

      - name: Record backup branch
        run: |
          echo "## ðŸ’¾ Database Backup Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Backup Branch** | \`backup/pre-deploy-${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Parent** | \`main\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This backup can be used for rollback if needed." >> $GITHUB_STEP_SUMMARY

  # Apply migrations to production
  migrate-production:
    name: Apply Production Migrations
    runs-on: ubuntu-latest
    needs: backup-database
    if: inputs.skip_migrations != true
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn db:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}

      - name: Check pending migrations
        id: check-migrations
        run: ./.github/scripts/check-migration-status.sh
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}

      - name: Apply Migrations
        if: steps.check-migrations.outputs.has_pending == 'true'
        run: |
          echo "ðŸš€ Applying migrations to production..."
          yarn workspace @salonko/prisma prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}

      - name: Verify Migration Success
        run: |
          echo "Verifying migration status..."
          yarn workspace @salonko/prisma prisma migrate status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}

      - name: Migration Summary
        run: |
          echo "## ðŸš€ Production Migration Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Migrations Applied** | ${{ steps.check-migrations.outputs.has_pending == 'true' && 'Yes' || 'No (up to date)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backup Branch** | \`backup/pre-deploy-${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # Sync develop branch with main after successful deployment
  sync-develop-schema:
    name: Sync Develop Database
    runs-on: ubuntu-latest
    needs: migrate-production
    if: always() && needs.migrate-production.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn db:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEVELOP }}

      - name: Apply Migrations to Develop
        run: |
          echo "Syncing develop database with production schema..."
          yarn workspace @salonko/prisma prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEVELOP }}

      - name: Sync Summary
        run: |
          echo "## ðŸ”„ Develop Database Synced" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The develop database has been synced with production schema." >> $GITHUB_STEP_SUMMARY

  # Cleanup old backup branches (keep last 5)
  cleanup-old-backups:
    name: Cleanup Old Backup Branches
    runs-on: ubuntu-latest
    needs: migrate-production
    if: always() && needs.migrate-production.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup old backup branches
        run: ./.github/scripts/cleanup-neon-backups.sh
        env:
          KEEP_COUNT: 5

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate, backup-database, migrate-production]
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The production deployment has failed. Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If migrations were partially applied, you can restore from the backup branch:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Neon Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Find branch: \`backup/pre-deploy-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Restore the main branch from this backup" >> $GITHUB_STEP_SUMMARY
